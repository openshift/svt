## OpenShift Templates
This directory contains templates to deploy tooling on OpenShift.

### Prepare the nodes you want to monitor
The nodes need to have pbench-agent, collectd images on it. The qcow images generated by the image provisioner already has the images baked in. In case the nodes doesn't have the images, please pull them from dockerhub:
#### pbench-agent
```
$ docker pull ravielluri/image:agent
$ docker tag ravielluri/image:agent pbench-agent:latest
```
#### collectd
```
$ docker pull ravielluri/image:collectd
$ docker tag ravielluri/image:agent collectd:latest
```

### Label the nodes with a pbench_role=agent label
```   
$ oc label node <node> pbench_role=agent
```

### Create a service account and add it to the privileged scc
```
$ oc create serviceaccount useroot
$ oc adm policy add-scc-to-user privileged -z useroot
```

### Create pbench-agent pods and patch it
```
$ oc create -f openshift_templates/performance_monitoring/pbench/pbench-agent-daemonset.yml
$ oc patch daemonset pbench-agent --patch \ '{"spec":{"template":{"spec":{"serviceAccountName": "useroot"}}}}'
```

### Create a configmap to feed credentials to the collectd pod
```
$ oc create -f openshift_templates/performance_monitoring/collectd/collectd-config.yml
```

### Create collectd pods and patch it
```
$ oc create -f openshift_templates/performance_monitoring/collectd/collectd-daemonset.yml
$ oc patch daemonset collectd --patch \ '{"spec":{"template":{"spec":{"serviceAccountName": "useroot"}}}}'
```
